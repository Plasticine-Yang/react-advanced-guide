<!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <link rel="icon" href="" type="image/svg+xml"></link>
      <script  id="check-dark-light">
        ;(() => {
          const saved = localStorage.getItem('island-theme-appearance')
          const prefereDark = window.matchMedia('(prefers-color-scheme: dark)').matches
          if (!saved || saved === 'auto' ? prefereDark : saved === 'dark') {
            document.documentElement.classList.add('dark')
          }
        })()
      </script>
      <title data-rh="true">state</title>
      <meta data-rh="true" name="description" content="Island"/>
      
      
      <script defer src='https://ga.jspm.io/npm:es-module-shims@1.6.0/dist/es-module-shims.js'></script>
      <script type="importmap">
        {
          "imports": {
            "react": "/react-advanced-guide/react.js","react-dom": "/react-advanced-guide/react-dom.js","react-dom/client": "/react-advanced-guide/react-dom_client.js","react/jsx-runtime": "/react-advanced-guide/react_jsx-runtime.js"
          }
        }
      </script>

      <link rel="stylesheet" href="/react-advanced-guide/assets/style.900da582.css">

    </head>
    <body>
      <div id="root"><div style="height:100%"><header relative="" z="4" fixed="md:~" class="top-0 left-0" w="100%"><div relative="" p="l-8 sm:x-8" transition="background-color duration-500" class="divider-bottom md:border-b-transparent lg:border-b-transparent" nav-h="mobile lg:desktop"><div flex="" justify="between" m="0 auto" nav-h="mobile lg:desktop" class="_container_1ic07_52  _has-sidebar_1ic07_16"><div shrink="0" border="border t-0 b-1 border-solid transparent" class="_nav-bar-title_1ic07_16"><a href="/react-advanced-guide/" w="100%" h="100%" text="1rem" font="semibold" transition="opacity duration-300" hover="opacity-60" class="flex items-center"><span>React Advanced Guide</span></a></div><div class="_content_1ic07_24" flex="~ 1" justify="end" items-center=""><div class="search" flex="sm:1" pl="sm:8"><div __island="Search:1"><div flex="" items-center="~" relative="" mr="2" font="semibold"><svg width="32" height="32" viewBox="0 0 32 32" w="5" h="5" fill="currentColor"><path fill="#888888" d="m29 27.586l-7.552-7.552a11.018 11.018 0 1 0-1.414 1.414L27.586 29ZM4 13a9 9 0 1 1 9 9a9.01 9.01 0 0 1-9-9Z"></path></svg><input disabled="" cursor="text focus:auto" placeholder="Search" height="8" border="none" type="text" text="sm" p="t-0 r-2 b-0 l-2" transition="all duration-200 ease" class="rounded-sm _searchInput_y03a3_1 " aria-label="Search" autoComplete="off"/><div m="r-3" w="10" h="6" p="x-1.5" rounded="md" border="1px solid gray-light-3" text="xs gray-light-3" flex="~" items-center="~" justify="around" class="_searchCommand_y03a3_7"><span>⌘</span><span>K</span></div></div></div></div><div class="_rightNav_1ic07_42"><div class="menu"><div text="sm" font="medium" m="x-3" class=""><a href="https://github.com/Plasticine-Yang/react-advanced-guide" target="_blank" rel="noopener noreferrer" class="_link_r3fql_1 ">Github</a></div></div><div class="appearance" before="menu-item-before" display="none sm:flex" items-center="center"><div __island="SwitchAppearance:3"><button class="_switch_1tqe3_1 undefined" id="" type="button" role="switch"><span class="_check_1tqe3_17"><span class="_icon_1tqe3_34"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_sun_8e60k_1"><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_moon_8e60k_5"><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></span></button></div></div></div><div __island="NavHamburger:2"><button class=" _navHamburger_14nz8_1"><span class="_container_14nz8_14"><span class="_top_14nz8_21"></span><span class="_middle_14nz8_27"></span><span class="_bottom_14nz8_33"></span></span></button><div class="_navScreen_1mkpq_1 " id="navScreen"><div class="_container_1mkpq_21"><div class="_navMenu_1mkpq_27"><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a href="https://github.com/Plasticine-Yang/react-advanced-guide" target="_blank" rel="noopener noreferrer" class="_link_r3fql_1 ">Github</a></div></div></div><div class="_socialAndAppearance_1mkpq_50" flex="~" justify="center" items-center="center"><div class="items-center appearance pa-2 _navAppearance_1mkpq_46" flex="~" justify="center"><button class="_switch_1tqe3_1 undefined" id="" type="button" role="switch"><span class="_check_1tqe3_17"><span class="_icon_1tqe3_34"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_sun_8e60k_1"><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_moon_8e60k_5"><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></span></button></div></div></div></div></div></div></div></div></header><section style="padding-top:var(--island-nav-height)"><div p="t-0 x-6 b-24 sm:6" class="_docLayout_5cssi_8"><div __island="SideMenu:4"><div class="_localNav_ncerp_1"><button flex="center" class="_menu_ncerp_16"><div text="md" mr="2" class="i-carbon:menu"></div><span text="md ">Menu</span></button></div><aside class="_sidebar_iav29_1 "><nav><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">基础篇</h2></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:224px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/basics/jsx.html" target="" class="_link_r3fql_1 ">jsx</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/basics/component.html" target="" class="_link_r3fql_1 ">component</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-brand"><a href="/react-advanced-guide/guide/basics/state.html" target="" class="_link_r3fql_1 ">state</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/basics/props.html" target="" class="_link_r3fql_1 ">props</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/basics/life-cycle.html" target="" class="_link_r3fql_1 ">life cycle</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/basics/ref.html" target="" class="_link_r3fql_1 ">ref</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/basics/context.html" target="" class="_link_r3fql_1 ">context</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/basics/HOC.html" target="" class="_link_r3fql_1 ">HOC</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">优化篇</h2></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:84px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/optimization/render-control.html" target="" class="_link_r3fql_1 ">渲染控制</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/optimization/render-tuning.html" target="" class="_link_r3fql_1 ">渲染调优</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/optimization/render-massive-data.html" target="" class="_link_r3fql_1 ">渲染海量数据</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">原理篇</h2></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:28px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a href="/react-advanced-guide/guide/principle/old-event.html" target="" class="_link_r3fql_1 ">事件原理 -- 旧版本</a></div></div></div></div></section></nav></aside></div><div flex="~ 1 shrink-0" m="x-auto" class="_content_5cssi_2"><div m="x-auto" flex="~ col" class="max-w-100%"><div relative="~" m="x-auto" p="l-2" class="w-100% md:max-w-712px lg:min-w-640px "><div class="island-doc "><!--$--><h1 id="state"><a class="header-anchor" aria-hidden="true" href="#state">#</a>state</h1>
<h2 id="1-类组件中的-state"><a class="header-anchor" aria-hidden="true" href="#1-类组件中的-state">#</a>1. 类组件中的 state</h2>
<h3 id="11-setstate-的用法"><a class="header-anchor" aria-hidden="true" href="#11-setstate-的用法">#</a>1.1. setState 的用法</h3>
<h4 id="111-对象形式-setstate"><a class="header-anchor" aria-hidden="true" href="#111-对象形式-setstate">#</a>1.1.1. 对象形式 setState</h4>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> 对象形式 setState */</span></span>
<span class="line"><span style="color:#81A1C1">interface</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">SetStateDemo1State</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  counter</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">number</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#81A1C1">class</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">SetStateDemo1</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">extends</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB;font-style:italic">Component</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  state</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Readonly</span><span style="color:#ECEFF4">&lt;</span><span style="color:#8FBCBB">SetStateDemo1State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">render</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">ReactNode</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;p&gt;</span><span style="color:#D8DEE9FF">counter: </span><span style="color:#81A1C1">{this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;button</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">            </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">              </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">                </span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">对象形式 setState 之后的 counter: </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#ECEFF4">,</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">              )</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">            </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#81A1C1">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">          对象形式 setState</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>counter: <!-- -->0</p><button>对象形式 setState</button></div></div>
<h4 id="112-函数形式-setstate"><a class="header-anchor" aria-hidden="true" href="#112-函数形式-setstate">#</a>1.1.2. 函数形式 setState</h4>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> 函数形式 setState */</span></span>
<span class="line"><span style="color:#81A1C1">interface</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">SetStateDemo2State</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  counter</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">number</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#81A1C1">class</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">SetStateDemo2</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">extends</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB;font-style:italic">Component</span><span style="color:#ECEFF4">&lt;{},</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">SetStateDemo2State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  state </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">render</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">ReactNode</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;p&gt;</span><span style="color:#D8DEE9FF">counter: </span><span style="color:#81A1C1">{this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;button</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">            </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">              </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">props</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> (</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">,</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">              </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">                </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">                  </span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">函数形式 setState 之后的 counter: </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#ECEFF4">,</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">                )</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">              </span><span style="color:#ECEFF4">},</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">            )</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#81A1C1">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">          函数形式 setState</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>counter: <!-- -->0</p><button>函数形式 setState</button></div></div>
<h3 id="12-setstate-底层做了什么"><a class="header-anchor" aria-hidden="true" href="#12-setstate-底层做了什么">#</a>1.2. setState 底层做了什么？</h3>
<ol>
<li>产生当前更新的优先级 -- 老版本中使用 <code>expirationTime</code> 新版本使用 <code>lane</code></li>
<li>从 <code>fiber root</code> 开始调和:
2.1. 也就是对比新老虚拟 DOM，找出发生变化的部分
2.2. 再对比 <code>expirationTime</code> 找到发生更新的组件
2.3. 合并 state，触发 render 函数，得到新的 UI 视图，完成 render 阶段</li>
<li>commit 阶段，将虚拟 DOM 更新成真实 DOM，更新后再执行 setState 的第二个回调参数</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/setState%E5%BA%95%E5%B1%82%E9%80%BB%E8%BE%91.png" alt="setState底层逻辑"/></p>
<h3 id="13-如何限制-state-更新视图"><a class="header-anchor" aria-hidden="true" href="#13-如何限制-state-更新视图">#</a>1.3. 如何限制 state 更新视图</h3>
<ol>
<li><code>pureComponent</code> -- 只会对 state 和 props 进行 shallow 比较</li>
<li><code>shouldComponentUpdate</code> 生命周期 -- 需要更新则返回 true，否则返回 false</li>
</ol>
<h3 id="14-从源码理解-setstate-原理"><a class="header-anchor" aria-hidden="true" href="#14-从源码理解-setstate-原理">#</a>1.4. 从源码理解 setState 原理</h3>
<p>上一节中讲到过，类组件的 setState 本质上是调用了 updater 对象上的 enqueueSetState 方法，从命名上看就知道 updater 对象专门负责用来更新组件的</p>
<p>既然更新 state 会更新视图，那么如果在事件处理函数中多次执行 setState 操作的话是否意味着每个 setState 都会触发视图更新呢？还是说 React 会智能地将多次 setState 对状态的改变合并成最终状态，再批量更新呢？</p>
<p>带着这个问题，我们来到源码当中探索一下</p>
<p>想要弄明白 setState 的原理，就需要从以下两方面入手：</p>
<ol>
<li>enqueueSetState 做了什么？</li>
<li>React 底层如何进行批量更新的？</li>
</ol>
<h4 id="141-enqueuesetstate-做了什么"><a class="header-anchor" aria-hidden="true" href="#141-enqueuesetstate-做了什么">#</a>1.4.1. enqueueSetState 做了什么？</h4>
<p>这里对源码进行简化，挑出核心部分：</p>
<p><code>packages/react-reconciler/src/ReactFiberClassComponent.old.js</code></p>
<div class="language-js" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">js</span><pre><code class=""><span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">classComponentUpdater</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">enqueueSetState</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">...</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">callback</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 每次调用 setState 都会创建一个 update 对象维护更新所需信息</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">update</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">createUpdate</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">eventTime</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">lane</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 挂载 setState 的第二个回调参数到 update 对象上</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> (</span><span style="color:#D8DEE9">callback</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!==</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">undefined</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">callback</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">!==</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">null</span><span style="color:#D8DEE9FF">) </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">update</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">callback</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">callback</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 将 fiber 以及对应的 update 对象加入到更新队列中</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">enqueueUpdate</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">fiber</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">update</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 调度更新 -- 调和阶段</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">scheduleUpdateOnFiber</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">root</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">fiber</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">lane</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">eventTime</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">},</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<h4 id="142-react-底层如何进行批量更新的"><a class="header-anchor" aria-hidden="true" href="#142-react-底层如何进行批量更新的">#</a>1.4.2. React 底层如何进行批量更新的？</h4>
<p>React 的 batchUpdate 是什么时候加上去的呢？</p>
<p>这和 React 的事件系统有关，React 底层有一套事件系统统一调度事件，而 batchUpdate 则是作为一种事件被事件系统调度执行的</p>
<p><code>packages/react-dom-bindings/src/events/DOMPluginEventSystem.js</code></p>
<div class="language-js" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">js</span><pre><code class=""><span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">dispatchEventForPluginEventSystem</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">batchedUpdates</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">dispatchEventsForPlugins</span><span style="color:#D8DEE9FF">(</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">domEventName</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">eventSystemFlags</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">nativeEvent</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">ancestorInst</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">targetContainer</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">    )</span><span style="color:#ECEFF4">,</span></span>
<span class="line"><span style="color:#D8DEE9FF">  )</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<p>这里的 batchedUpdates 函数就是批量更新的重点</p>
<p><code>packages/react-dom-bindings/src/events/ReactDOMUpdateBatching.js</code></p>
<div class="language-js" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">js</span><pre><code class=""><span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">function</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">batchedUpdates</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">fn</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">a</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">b</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 开启批量更新</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#D8DEE9">isInsideEventHandler</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">try</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 这里执行事件处理函数，setState 就是在这里面被执行的</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">batchedUpdatesImpl</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">fn</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">a</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">b</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">finally</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// try 中 return 不影响 finally 的执行</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 完成事件处理函数后关闭标志变量，开始批量更新</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">isInsideEventHandler</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">false</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<h4 id="143-同步事件处理函数正常执行流程"><a class="header-anchor" aria-hidden="true" href="#143-同步事件处理函数正常执行流程">#</a>1.4.3. 同步事件处理函数正常执行流程</h4>
<p>通过一个例子来看看这个过程会更加好理解</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> batchUpdate 的流程 -- 在事件处理函数中执行同步操作 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">React</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">interface</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo1State</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  counter</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">number</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#81A1C1">class</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo1</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">extends</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB;font-style:italic">Component</span><span style="color:#ECEFF4">&lt;{},</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo1State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  state</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Readonly</span><span style="color:#ECEFF4">&lt;</span><span style="color:#8FBCBB">BatchUpdateDemo1State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">handleClick</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 1 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 2 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 3 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">render</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">ReactNode</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">{this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter++</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">BatchUpdateDemo1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>0</p><button>counter++</button></div></div>
<p>控制台输出如下：</p>
<p><img src="https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/BatchUpdateDemo1%E6%8E%A7%E5%88%B6%E5%8F%B0%E8%BE%93%E5%87%BA.png" alt="BatchUpdateDemo1控制台输出"/></p>
<p>为什么结果是这样的呢？我们结合刚刚看过的源码分析一下</p>
<p>首先通过按钮点击触发事件处理函数<code>handleClick</code>，它会被 React 的事件系统托管，由事件系统统一调度</p>
<p>也就是在 <code>batchedUpdates</code> 这个函数上下文中进行，那么我们结合刚才的精简版画一个这个函数上下文中的执行情况如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E5%9C%A8React%E5%BA%95%E5%B1%82%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="事件处理函数在React底层的执行流程"/></p>
<p>相信现在你能理解为什么输出情况是上面那样了</p>
<h4 id="144-异步事件处理函数执行流程"><a class="header-anchor" aria-hidden="true" href="#144-异步事件处理函数执行流程">#</a>1.4.4. 异步事件处理函数执行流程</h4>
<p>如果我们在 handleClick 中有异步操作会发生什么呢？</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> batchUpdate 的流程 -- 在事件处理函数中执行异步操作 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">React</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">interface</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo2State</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  counter</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">number</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#81A1C1">class</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo2</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">extends</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB;font-style:italic">Component</span><span style="color:#ECEFF4">&lt;{},</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo2State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  state</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Readonly</span><span style="color:#ECEFF4">&lt;</span><span style="color:#8FBCBB">BatchUpdateDemo2State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">handleClick</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">setTimeout</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 1 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 2 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 3 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">render</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">ReactNode</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">{this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter++</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">BatchUpdateDemo2</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>0</p><button>counter++</button></div></div>
<p>异步任务并没有在事件系统的 <code>batchUpdates</code> 函数上下文中执行，因而里面的 setState 并不会被批量更新，而是一次一次地修改 state，然后更新视图</p>
<div class="island-directive tip"><p class="island-directive-title">TIP</p><div class="island-directive-content"><p>这个现象只在 React 17 及之前存在，18 开始默认支持异步操作中进行批量更新</p><blockquote>
<p>Before React 18, only updates inside React event handlers were batched. Starting with React 18, batching is enabled for all updates by default.</p>
</blockquote><blockquote>
<p>React 18 adds out-of-the-box performance improvements by doing more batching by default. Batching is when React groups multiple state updates into a single re-render for better performance. Before React 18, we only batched updates inside React event handlers. Updates inside of promises, setTimeout, native event handlers, or any other event were not batched in React by default</p>
</blockquote></div></div>
<h3 id="15-unstable_batchedupdates----让事件处理函数中异步操作里的-setstate-批量更新"><a class="header-anchor" aria-hidden="true" href="#15-unstable_batchedupdates----让事件处理函数中异步操作里的-setstate-批量更新">#</a>1.5. unstable_batchedUpdates -- 让事件处理函数中异步操作里的 setState 批量更新</h3>
<p>如何让异步操作中的多次 setState 也批量更新呢？</p>
<p>ReactDOM 中提供了一个 <code>unstable_batchedUpdates</code> API，能够允许我们手动开启 setState 批量更新</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> batchUpdate 的流程 -- 事件处理函数的异步操作中 setState 批量更新 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">React</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line highlighted"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">unstable_batchedUpdates</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-dom</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">interface</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo3State</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  counter</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">number</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#81A1C1">class</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo3</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">extends</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB;font-style:italic">Component</span><span style="color:#ECEFF4">&lt;{},</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo3State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  state</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Readonly</span><span style="color:#ECEFF4">&lt;</span><span style="color:#8FBCBB">BatchUpdateDemo3State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">handleClick</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">setTimeout</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">      </span><span style="color:#88C0D0">unstable_batchedUpdates</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 1 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 2 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">          </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">callback 3 -- </span><span style="color:#ECEFF4">${</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">render</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">ReactNode</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">{this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter++</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">BatchUpdateDemo3</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>0</p><button>counter++</button></div></div>
<div class="island-directive tip"><p class="island-directive-title">unstable_batchedUpdates 使用场景</p><div class="island-directive-content"><p>当用 ajax 请求数据后如果有多次 setState 操作，可以考虑使用 unstable_batchedUpdates 包裹这些多次 setState 操作，开启批量更新 state 的特性，避免不必要地多次更新中间 state 视图</p></div></div>
<h3 id="16-提升更新任务优先级"><a class="header-anchor" aria-hidden="true" href="#16-提升更新任务优先级">#</a>1.6. 提升更新任务优先级</h3>
<p>ReactDOM 提供的 <code>flushSync</code> API 可以将传入的回调放在一个较高的优先级</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> 提升更新任务优先级 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">React</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line highlighted"><span style="color:#81A1C1">import</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">ReactDOM</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">from</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">react-dom</span><span style="color:#ECEFF4">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">interface</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo4State</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  counter</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">number</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#81A1C1">class</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo4</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">extends</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB;font-style:italic">Component</span><span style="color:#ECEFF4">&lt;{},</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">BatchUpdateDemo4State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  state</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">Readonly</span><span style="color:#ECEFF4">&lt;</span><span style="color:#8FBCBB">BatchUpdateDemo4State</span><span style="color:#ECEFF4">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">handleClick</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">setTimeout</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">2</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">ReactDOM</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">flushSync</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">3</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line highlighted"></span>
<span class="line highlighted"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">setState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">4</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">render</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">ReactNode</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">&#x27;</span><span style="color:#A3BE8C">BatchUpdateDemo4 -- </span><span style="color:#ECEFF4">&#x27;</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">{this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter++</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    )</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">export</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">BatchUpdateDemo4</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>0</p><button>counter++</button></div></div>
<p><img src="https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/flushSync%E6%8F%90%E5%8D%87%E6%9B%B4%E6%96%B0%E4%BB%BB%E5%8A%A1%E4%BC%98%E5%85%88%E7%BA%A7.png" alt="flushSync提升更新任务优先级"/></p>
<p>可以看到，有了 <code>flushSync</code> 后，尽管前面有一个将 counter 设置为 2 的 setState，但是渲染函数并没有执行</p>
<p>也就是说 <code>flushSync</code> 会与前面的同步 setState 进行合并后再渲染</p>
<div class="island-directive tip"><p class="island-directive-title">更新任务优先级</p><div class="island-directive-content"><p>flushSync 中的 setState &gt; 正常执行上下文中的 setState &gt; 异步操作(如 setTimeout, promise.then)中的 setState</p></div></div>
<h2 id="2-函数组件中的-state"><a class="header-anchor" aria-hidden="true" href="#2-函数组件中的-state">#</a>2. 函数组件中的 state</h2>
<h3 id="21-usestate-的用法"><a class="header-anchor" aria-hidden="true" href="#21-usestate-的用法">#</a>2.1. useState 的用法</h3>
<p>关于 useState 的用法相信大家都比较熟悉了，不过这里还是稍微提一下</p>
<h4 id="211-initialstate"><a class="header-anchor" aria-hidden="true" href="#211-initialstate">#</a>2.1.1. initialState</h4>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">[</span><span style="color:#D8DEE9">state</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">setState</span><span style="color:#ECEFF4">]</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">useState</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">initialState</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span></code></pre></div>
<p>常见的用法是 initialState 直接初始化一个数据，比如 number、string、boolean、object 等</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> initialState 使用直接数据 */</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">UseStateDemo1</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">FC</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">[</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">setCounter</span><span style="color:#ECEFF4">]</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">useState</span><span style="color:#D8DEE9FF">(</span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">setCounter</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;p&gt;{</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter++</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  )</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>0</p><button>counter++</button></div></div>
<p>但其实 initialState 也能是一个函数，函数的返回值作为初始 state，这个场景用在哪里呢？</p>
<p>它可以用在懒加载的场景，当 initialState 是一个需要复杂计算才能获得的值时，就适合用函数的方式作为 initialState</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> initialState 使用函数 */</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">UseStateDemo2</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">FC</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">[</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">setCounter</span><span style="color:#ECEFF4">]</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">useState</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 假设这里有很多复杂计算...</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">value</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">Math</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">random</span><span style="color:#D8DEE9FF">() </span><span style="color:#81A1C1">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0.5</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">?</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 计算完后返回值作为 initialState</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">value</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">setCounter</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;p&gt;{</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter++</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  )</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>1</p><button>counter++</button></div></div>
<p>初始值只会在首次渲染的时候被计算，后续更新渲染时不会再重复执行计算逻辑</p>
<h4 id="212-setstate"><a class="header-anchor" aria-hidden="true" href="#212-setstate">#</a>2.1.2. setState</h4>
<p>setState 常见的是直接赋值使用，传入新的 state，但实际上他还支持传入函数，这个函数也被称为 reducer</p>
<p>reducer 的参数是旧 state，使用时需要生成新 state 后返回</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> setState reducer */</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">UseStateDemo3</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">FC</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">[</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">setCounter</span><span style="color:#ECEFF4">]</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">useState</span><span style="color:#D8DEE9FF">(</span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 直接 setState</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">setCounter</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">    </span><span style="color:#616E88">// 使用 reducer 的方式 setState</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#88C0D0">setCounter</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;p&gt;{</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">handleClick</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter + 2</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  )</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>0</p><button>counter + 2</button></div></div>
<div class="island-directive warning"><p class="island-directive-title">使用 reducer 时的注意事项</p><div class="island-directive-content"><p>如果 state 是一个 object，那么不应该在 reducer 中直接修改旧 state，而是拷贝一份后对副本进行修改并返回副本</p><p>因为 react 底层对 state 的对比是浅比较的，也就是说如果新旧 state 都是指向同一个内存地址的对象，那么即使它们的属性发生了变化，视图也不会进行更新</p><p>这就是所谓的 <code>immutable</code> 数据，这对 react 底层性能优化有重要意义</p></div></div>
<h3 id="22-如何监听-state-变化"><a class="header-anchor" aria-hidden="true" href="#22-如何监听-state-变化">#</a>2.2. 如何监听 state 变化？</h3>
<p>在类组件中我们要监听 state 变化时，有两种方式：</p>
<ol>
<li>在 <code>this.setState</code> 的第二个回调参数中获取变化后的 state 进行操作</li>
<li>在 <code>componentDidUpdate</code> 生命周期中获取更新后的 state</li>
</ol>
<p>那么在函数组件中如何类似地对 state 进行监听呢？</p>
<p>可以使用 <code>useEffect</code> 这个 hook</p>
<p>在第一个回调参数中编写监听逻辑，将要监听的 state 放到第二个数组参数中即可在 state 变化时执行第一个回调参数</p>
<div class="language-tsx" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">tsx</span><pre><code class=""><span class="line"><span style="color:#616E88">/** </span><span style="color:#ECEFF4">@</span><span style="color:#81A1C1">description</span><span style="color:#616E88"> 监听 counter 变化 */</span></span>
<span class="line"><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">UseEffectDemo1</span><span style="color:#81A1C1">:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">React</span><span style="color:#ECEFF4">.</span><span style="color:#8FBCBB">FC</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">const</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">[</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> </span><span style="color:#D8DEE9">setCounter</span><span style="color:#ECEFF4">]</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">useState</span><span style="color:#D8DEE9FF">(</span><span style="color:#B48EAD">0</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ECEFF4">  </span><span style="color:#616E88">// 在 useEffect 中监听 counter 变化</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#88C0D0">useEffect</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#D8DEE9">console</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">counter changed: </span><span style="color:#ECEFF4">${</span><span style="color:#D8DEE9">counter</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#ECEFF4">},</span><span style="color:#D8DEE9FF"> [</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9FF">  </span><span style="color:#81A1C1">return</span><span style="color:#D8DEE9FF"> (</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;p&gt;{</span><span style="color:#D8DEE9">counter</span><span style="color:#81A1C1">}&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">      </span><span style="color:#81A1C1">&lt;button</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">onClick</span><span style="color:#81A1C1">={</span><span style="color:#ECEFF4">()</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">setCounter</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">counter</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">}&gt;</span><span style="color:#D8DEE9FF">counter++</span><span style="color:#81A1C1">&lt;/button&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">  )</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span></code></pre></div>
<div class="_container_1d1ak_1"><div><p>0</p><button>counter++</button></div></div>
<h2 id="3-对比类组件和函数组件中的-state"><a class="header-anchor" aria-hidden="true" href="#3-对比类组件和函数组件中的-state">#</a>3. 对比类组件和函数组件中的 state</h2>
<p><strong>相同点：</strong></p>
<ul>
<li>底层都调用了 <code>scheduleUpdateOnFiber</code> 方法，并且在事件系统中都有批量更新 state 的特性</li>
</ul>
<p><strong>不同点：</strong></p>
<ul>
<li>对于非 PureComponent 而言，类组件 setState 不会浅比较新旧 state，只要调用了就更新；而函数组件的 useState 会默认比较新旧 state 是否是同一个对象来决定是否进行更新</li>
<li>setState 倾向于合并 state 进行更新；useState 倾向于拷贝原 state，对副本进行改变触发更新</li>
<li>setState 可以通过第二个回调参数或者 componentDidUpdate 生命周期监听 state 变化；useState 需要配合 useEffect 来监听 state 变化</li>
</ul><!--/$--></div><footer mt="8"><div class="xs:flex" p="b-5" justify="between" items-center="~"><div flex="" text="sm text-2" leading-6="~" leading-8="sm:~" font-medium=""><p>Last Updated: </p><span>2022/12/14 06:33:26</span></div></div><div flex="~ col sm:row" justify="sm:around" gap="2" divider-top="" pt="6"><div flex="~ col" class="_prev_1f77m_13"></div><div flex="~ col" class="_next_1f77m_16"><a href="/guide/basics/jsx.html" class="_pager-link_1f77m_20 _next_1f77m_16"><span class="_desc_1f77m_43">Next page</span><span class="_title_1f77m_34">jsx</span></a></div></div></footer></div></div><div relative="~" display="none lg:block" order="2" flex="1" p="l-8" class="max-w-256px"><div class="_aside-container_5cssi_32"><div flex="~ col" p="b-8" style="min-height:calc(100vh - (var(--island-nav-height-desktop) + 32px))"><div><div flex="~ col 1"><div display="lg:block"><div relative="" divider-left="" p="l-4" text="13px" font-medium="" id="aside-container"><div absolute="" pos="top-33px" opacity="0" w="1px" h="18px" bg="brand" style="left:-1px;transition:top 0.25s cubic-bezier(0, 1, 0.5, 1), background-color 0.5s, opacity 0.25s" id="aside-marker"></div><div block="~" leading-7="" text="13px" font="semibold">目录</div><nav><ul relative=""><li><a href="#1-类组件中的-state" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">1. 类组件中的 state</a></li><li><a href="#11-setstate-的用法" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">1.1. setState 的用法</a></li><li><a href="#111-对象形式-setstate" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">1.1.1. 对象形式 setState</a></li><li><a href="#112-函数形式-setstate" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">1.1.2. 函数形式 setState</a></li><li><a href="#12-setstate-底层做了什么" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">1.2. setState 底层做了什么？</a></li><li><a href="#13-如何限制-state-更新视图" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">1.3. 如何限制 state 更新视图</a></li><li><a href="#14-从源码理解-setstate-原理" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">1.4. 从源码理解 setState 原理</a></li><li><a href="#141-enqueuesetstate-做了什么" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">1.4.1. enqueueSetState 做了什么？</a></li><li><a href="#142-react-底层如何进行批量更新的" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">1.4.2. React 底层如何进行批量更新的？</a></li><li><a href="#143-同步事件处理函数正常执行流程" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">1.4.3. 同步事件处理函数正常执行流程</a></li><li><a href="#144-异步事件处理函数执行流程" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">1.4.4. 异步事件处理函数执行流程</a></li><li><a href="#15-unstable_batchedupdates----让事件处理函数中异步操作里的-setstate-批量更新" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">1.5. unstable_batchedUpdates -- 让事件处理函数中异步操作里的 setState 批量更新</a></li><li><a href="#16-提升更新任务优先级" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">1.6. 提升更新任务优先级</a></li><li><a href="#2-函数组件中的-state" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">2. 函数组件中的 state</a></li><li><a href="#21-usestate-的用法" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">2.1. useState 的用法</a></li><li><a href="#211-initialstate" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">2.1.1. initialState</a></li><li><a href="#212-setstate" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:24px">2.1.2. setState</a></li><li><a href="#22-如何监听-state-变化" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">2.2. 如何监听 state 变化？</a></li><li><a href="#3-对比类组件和函数组件中的-state" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">3. 对比类组件和函数组件中的 state</a></li></ul></nav></div></div></div></div></div></div></div></div></div></section><div __island="BackTop:0"></div></div></div>
      
      <script id="island-props">[{},{"langRoutePrefix":""},{"localeData":{"nav":[{"text":"Github","link":"https://github.com/Plasticine-Yang/react-advanced-guide"}],"sidebar":{"/guide/":[{"text":"基础篇","items":[{"text":"jsx","link":"/guide/basics/jsx"},{"text":"component","link":"/guide/basics/component"},{"text":"state","link":"/guide/basics/state"},{"text":"props","link":"/guide/basics/props"},{"text":"life cycle","link":"/guide/basics/life-cycle"},{"text":"ref","link":"/guide/basics/ref"},{"text":"context","link":"/guide/basics/context"},{"text":"HOC","link":"/guide/basics/HOC"}]},{"text":"优化篇","items":[{"text":"渲染控制","link":"/guide/optimization/render-control"},{"text":"渲染调优","link":"/guide/optimization/render-tuning"},{"text":"渲染海量数据","link":"/guide/optimization/render-massive-data"}]},{"text":"原理篇","items":[{"text":"事件原理 -- 旧版本","link":"/guide/principle/old-event"}]}]}},"siteData":{"lang":"en-US","title":"Island","description":"Island","themeConfig":{"siteTitle":"React Advanced Guide","outlineTitle":"目录","nav":[{"text":"Github","link":"https://github.com/Plasticine-Yang/react-advanced-guide"}],"sidebar":{"/guide/":[{"text":"基础篇","items":[{"text":"jsx","link":"/guide/basics/jsx"},{"text":"component","link":"/guide/basics/component"},{"text":"state","link":"/guide/basics/state"},{"text":"props","link":"/guide/basics/props"},{"text":"life cycle","link":"/guide/basics/life-cycle"},{"text":"ref","link":"/guide/basics/ref"},{"text":"context","link":"/guide/basics/context"},{"text":"HOC","link":"/guide/basics/HOC"}]},{"text":"优化篇","items":[{"text":"渲染控制","link":"/guide/optimization/render-control"},{"text":"渲染调优","link":"/guide/optimization/render-tuning"},{"text":"渲染海量数据","link":"/guide/optimization/render-massive-data"}]},{"text":"原理篇","items":[{"text":"事件原理 -- 旧版本","link":"/guide/principle/old-event"}]}]},"footer":{"message":"Released under the MIT License.","copyright":"Copyright © 2022-present Plasticine Yang"}},"head":[["script",{"id":"check-dark-light"},"\n        ;(() => {\n          const saved = localStorage.getItem('island-theme-appearance')\n          const prefereDark = window.matchMedia('(prefers-color-scheme: dark)').matches\n          if (!saved || saved === 'auto' ? prefereDark : saved === 'dark') {\n            document.documentElement.classList.add('dark')\n          }\n        })()\n      "]],"base":"/react-advanced-guide/","icon":"","root":"/home/runner/work/react-advanced-guide/react-advanced-guide/docs","appearance":true},"pathname":"/react-advanced-guide/guide/basics/state"},{},{"pathname":"/react-advanced-guide/guide/basics/state","langRoutePrefix":"","sidebarData":[{"text":"基础篇","items":[{"text":"jsx","link":"/guide/basics/jsx"},{"text":"component","link":"/guide/basics/component"},{"text":"state","link":"/guide/basics/state"},{"text":"props","link":"/guide/basics/props"},{"text":"life cycle","link":"/guide/basics/life-cycle"},{"text":"ref","link":"/guide/basics/ref"},{"text":"context","link":"/guide/basics/context"},{"text":"HOC","link":"/guide/basics/HOC"}]},{"text":"优化篇","items":[{"text":"渲染控制","link":"/guide/optimization/render-control"},{"text":"渲染调优","link":"/guide/optimization/render-tuning"},{"text":"渲染海量数据","link":"/guide/optimization/render-massive-data"}]},{"text":"原理篇","items":[{"text":"事件原理 -- 旧版本","link":"/guide/principle/old-event"}]}]}]</script><script type="module" src="/react-advanced-guide/assets/island_inject.fab74cb0.js"></script>
      <script type="module">import Le,{createContext as ke}from"react";import{jsx as Ce}from"react/jsx-runtime";const Ae="modulepreload",Ie=function(e){return"/react-advanced-guide/"+e},ne={},Oe=function(t,n,i){return!n||n.length===0?t():Promise.all(n.map(r=>{if(r=Ie(r),r in ne)return;ne[r]=!0;const s=r.endsWith(".css"),p=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${p}`))return;const a=document.createElement("link");if(a.rel=s?"stylesheet":Ae,s||(a.as="script",a.crossOrigin=""),a.href=r,document.head.appendChild(a),s)return new Promise((f,_)=>{a.addEventListener("load",f),a.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${r}`)))})})).then(()=>t())};const ue=()=>typeof window<"u";ke({data:ue()?window==null?void 0:window.ISLAND_PAGE_DATA:null,setData:e=>{}});const je="island-theme-appearance";let He,W,V;typeof window<"u"&&typeof localStorage<"u"&&(W=localStorage.getItem(je)||"auto",V=window.matchMedia("(prefers-color-scheme: dark)"),W==="auto"&&V.matches,V.onchange=e=>{W==="auto"&&Ne(e.matches)});const Ne=e=>{He[e?"add":"remove"]("dark")};var Re=typeof global=="object"&&global&&global.Object===Object&&global;const Pe=Re;var $e=typeof self=="object"&&self&&self.Object===Object&&self,De=Pe||$e||Function("return this")();const me=De;var qe=me.Symbol;const Y=qe;var pe=Object.prototype,Me=pe.hasOwnProperty,Be=pe.toString,D=Y?Y.toStringTag:void 0;function Ue(e){var t=Me.call(e,D),n=e[D];try{e[D]=void 0;var i=!0}catch{}var r=Be.call(e);return i&&(t?e[D]=n:delete e[D]),r}var We=Object.prototype,Ge=We.toString;function Fe(e){return Ge.call(e)}var Ye="[object Null]",Ke="[object Undefined]",oe=Y?Y.toStringTag:void 0;function Xe(e){return e==null?e===void 0?Ke:Ye:oe&&oe in Object(e)?Ue(e):Fe(e)}function Ze(e){return e!=null&&typeof e=="object"}var Ve="[object Symbol]";function Je(e){return typeof e=="symbol"||Ze(e)&&Xe(e)==Ve}var Qe=/\s/;function et(e){for(var t=e.length;t--&&Qe.test(e.charAt(t)););return t}var tt=/^\s+/;function nt(e){return e&&e.slice(0,et(e)+1).replace(tt,"")}function K(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var re=0/0,ot=/^[-+]0x[0-9a-f]+$/i,rt=/^0b[01]+$/i,at=/^0o[0-7]+$/i,it=parseInt;function ae(e){if(typeof e=="number")return e;if(Je(e))return re;if(K(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=K(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=nt(e);var n=rt.test(e);return n||at.test(e)?it(e.slice(2),n?2:8):ot.test(e)?re:+e}var ct=function(){return me.Date.now()};const J=ct;var st="Expected a function",dt=Math.max,lt=Math.min;function ut(e,t,n){var i,r,s,p,a,f,_=0,g=!1,w=!1,z=!0;if(typeof e!="function")throw new TypeError(st);t=ae(t)||0,K(n)&&(g=!!n.leading,w="maxWait"in n,s=w?dt(ae(n.maxWait)||0,t):s,z="trailing"in n?!!n.trailing:z);function L(h){var u=i,o=r;return i=r=void 0,_=h,p=e.apply(o,u),p}function E(h){return _=h,a=setTimeout(H,t),g?L(h):p}function A(h){var u=h-f,o=h-_,O=t-u;return w?lt(O,s-o):O}function M(h){var u=h-f,o=h-_;return f===void 0||u>=t||u<0||w&&o>=s}function H(){var h=J();if(M(h))return B(h);a=setTimeout(H,A(h))}function B(h){return a=void 0,z&&i?L(h):(i=r=void 0,p)}function T(){a!==void 0&&clearTimeout(a),_=0,i=f=r=a=void 0}function N(){return a===void 0?p:B(J())}function C(){var h=J(),u=M(h);if(i=arguments,r=this,f=h,u){if(a===void 0)return E(f);if(w)return clearTimeout(a),a=setTimeout(H,t),L(f)}return a===void 0&&(a=setTimeout(H,t)),p}return C.cancel=T,C.flush=N,C}var mt="Expected a function";function pt(e,t,n){var i=!0,r=!0;if(typeof e!="function")throw new TypeError(mt);return K(n)&&(i="leading"in n?!!n.leading:i,r="trailing"in n?!!n.trailing:r),ut(e,t,{leading:i,maxWait:t,trailing:r})}var ft=function(){var e=document.getSelection();if(!e.rangeCount)return function(){};for(var t=document.activeElement,n=[],i=0;i<e.rangeCount;i++)n.push(e.getRangeAt(i));switch(t.tagName.toUpperCase()){case"INPUT":case"TEXTAREA":t.blur();break;default:t=null;break}return e.removeAllRanges(),function(){e.type==="Caret"&&e.removeAllRanges(),e.rangeCount||n.forEach(function(r){e.addRange(r)}),t&&t.focus()}},gt=ft,ie={"text/plain":"Text","text/html":"Url",default:"Text"},vt="Copy to clipboard: #{key}, Enter";function ht(e){var t=(/mac os x/i.test(navigator.userAgent)?"\u2318":"Ctrl")+"+C";return e.replace(/#{\s*key\s*}/g,t)}function _t(e,t){var n,i,r,s,p,a,f=!1;t||(t={}),n=t.debug||!1;try{r=gt(),s=document.createRange(),p=document.getSelection(),a=document.createElement("span"),a.textContent=e,a.ariaHidden="true",a.style.all="unset",a.style.position="fixed",a.style.top=0,a.style.clip="rect(0, 0, 0, 0)",a.style.whiteSpace="pre",a.style.webkitUserSelect="text",a.style.MozUserSelect="text",a.style.msUserSelect="text",a.style.userSelect="text",a.addEventListener("copy",function(g){if(g.stopPropagation(),t.format)if(g.preventDefault(),typeof g.clipboardData>"u"){n&&console.warn("unable to use e.clipboardData"),n&&console.warn("trying IE specific stuff"),window.clipboardData.clearData();var w=ie[t.format]||ie.default;window.clipboardData.setData(w,e)}else g.clipboardData.clearData(),g.clipboardData.setData(t.format,e);t.onCopy&&(g.preventDefault(),t.onCopy(g.clipboardData))}),document.body.appendChild(a),s.selectNodeContents(a),p.addRange(s);var _=document.execCommand("copy");if(!_)throw new Error("copy command was unsuccessful");f=!0}catch(g){n&&console.error("unable to copy using execCommand: ",g),n&&console.warn("trying IE specific stuff");try{window.clipboardData.setData(t.format||"text",e),t.onCopy&&t.onCopy(window.clipboardData),f=!0}catch(w){n&&console.error("unable to copy using clipboardData: ",w),n&&console.error("falling back to prompt"),i=ht("message"in t?t.message:vt),window.prompt(i,e)}}finally{p&&(typeof p.removeRange=="function"?p.removeRange(s):p.removeAllRanges()),a&&document.body.removeChild(a),r()}return f}var yt=_t;function bt(){const e=new Map;window.addEventListener("click",t=>{var i;const n=t.target;if(n.matches('div[class*="language-"] > button.copy')){const r=n.parentElement,s=(i=n.nextElementSibling)==null?void 0:i.nextElementSibling;if(!r||!s)return;const{innerText:p=""}=s;if(yt(p)){n.classList.add("copied"),clearTimeout(e.get(n));const f=setTimeout(()=>{n.classList.remove("copied"),n.blur(),e.delete(n)},2e3);e.set(n,f)}}})}/*! medium-zoom 1.0.6 | MIT License | https://github.com/francoischalifour/medium-zoom */var j=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},G=function(t){return t.tagName==="IMG"},wt=function(t){return NodeList.prototype.isPrototypeOf(t)},F=function(t){return t&&t.nodeType===1},ce=function(t){var n=t.currentSrc||t.src;return n.substr(-4).toLowerCase()===".svg"},se=function(t){try{return Array.isArray(t)?t.filter(G):wt(t)?[].slice.call(t).filter(G):F(t)?[t].filter(G):typeof t=="string"?[].slice.call(document.querySelectorAll(t)).filter(G):[]}catch{throw new TypeError(`The provided selector is invalid.
Expects a CSS selector, a Node element, a NodeList or an array.
See: https://github.com/francoischalifour/medium-zoom`)}},Et=function(t){var n=document.createElement("div");return n.classList.add("medium-zoom-overlay"),n.style.background=t,n},Tt=function(t){var n=t.getBoundingClientRect(),i=n.top,r=n.left,s=n.width,p=n.height,a=t.cloneNode(),f=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,_=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0;return a.removeAttribute("id"),a.style.position="absolute",a.style.top=i+f+"px",a.style.left=r+_+"px",a.style.width=s+"px",a.style.height=p+"px",a.style.transform="",a},P=function(t,n){var i=j({bubbles:!1,cancelable:!1,detail:void 0},n);if(typeof window.CustomEvent=="function")return new CustomEvent(t,i);var r=document.createEvent("CustomEvent");return r.initCustomEvent(t,i.bubbles,i.cancelable,i.detail),r},xt=function e(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=window.Promise||function(c){function d(){}c(d,d)},r=function(c){var d=c.target;if(d===O){E();return}T.indexOf(d)!==-1&&A({target:d})},s=function(){if(!(C||!o.original)){var c=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;Math.abs(h-c)>u.scrollOffset&&setTimeout(E,150)}},p=function(c){var d=c.key||c.keyCode;(d==="Escape"||d==="Esc"||d===27)&&E()},a=function(){var c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},d=c;if(c.background&&(O.style.background=c.background),c.container&&c.container instanceof Object&&(d.container=j({},u.container,c.container)),c.template){var v=F(c.template)?c.template:document.querySelector(c.template);d.template=v}return u=j({},u,d),T.forEach(function(y){y.dispatchEvent(P("medium-zoom:update",{detail:{zoom:b}}))}),b},f=function(){var c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e(j({},u,c))},_=function(){for(var c=arguments.length,d=Array(c),v=0;v<c;v++)d[v]=arguments[v];var y=d.reduce(function(m,S){return[].concat(m,se(S))},[]);return y.filter(function(m){return T.indexOf(m)===-1}).forEach(function(m){T.push(m),m.classList.add("medium-zoom-image")}),N.forEach(function(m){var S=m.type,k=m.listener,R=m.options;y.forEach(function(I){I.addEventListener(S,k,R)})}),b},g=function(){for(var c=arguments.length,d=Array(c),v=0;v<c;v++)d[v]=arguments[v];o.zoomed&&E();var y=d.length>0?d.reduce(function(m,S){return[].concat(m,se(S))},[]):T;return y.forEach(function(m){m.classList.remove("medium-zoom-image"),m.dispatchEvent(P("medium-zoom:detach",{detail:{zoom:b}}))}),T=T.filter(function(m){return y.indexOf(m)===-1}),b},w=function(c,d){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return T.forEach(function(y){y.addEventListener("medium-zoom:"+c,d,v)}),N.push({type:"medium-zoom:"+c,listener:d,options:v}),b},z=function(c,d){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return T.forEach(function(y){y.removeEventListener("medium-zoom:"+c,d,v)}),N=N.filter(function(y){return!(y.type==="medium-zoom:"+c&&y.listener.toString()===d.toString())}),b},L=function(){var c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},d=c.target,v=function(){var m={width:document.documentElement.clientWidth,height:document.documentElement.clientHeight,left:0,top:0,right:0,bottom:0},S=void 0,k=void 0;if(u.container)if(u.container instanceof Object)m=j({},m,u.container),S=m.width-m.left-m.right-u.margin*2,k=m.height-m.top-m.bottom-u.margin*2;else{var R=F(u.container)?u.container:document.querySelector(u.container),I=R.getBoundingClientRect(),X=I.width,ve=I.height,he=I.left,_e=I.top;m=j({},m,{width:X,height:ve,left:he,top:_e})}S=S||m.width-u.margin*2,k=k||m.height-u.margin*2;var $=o.zoomedHd||o.original,ye=ce($)?S:$.naturalWidth||S,be=ce($)?k:$.naturalHeight||k,U=$.getBoundingClientRect(),we=U.top,Ee=U.left,Q=U.width,ee=U.height,Te=Math.min(ye,S)/Q,xe=Math.min(be,k)/ee,Z=Math.min(Te,xe),Se=(-Ee+(S-Q)/2+u.margin+m.left)/Z,ze=(-we+(k-ee)/2+u.margin+m.top)/Z,te="scale("+Z+") translate3d("+Se+"px, "+ze+"px, 0)";o.zoomed.style.transform=te,o.zoomedHd&&(o.zoomedHd.style.transform=te)};return new i(function(y){if(d&&T.indexOf(d)===-1){y(b);return}var m=function X(){C=!1,o.zoomed.removeEventListener("transitionend",X),o.original.dispatchEvent(P("medium-zoom:opened",{detail:{zoom:b}})),y(b)};if(o.zoomed){y(b);return}if(d)o.original=d;else if(T.length>0){var S=T;o.original=S[0]}else{y(b);return}if(o.original.dispatchEvent(P("medium-zoom:open",{detail:{zoom:b}})),h=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,C=!0,o.zoomed=Tt(o.original),document.body.appendChild(O),u.template){var k=F(u.template)?u.template:document.querySelector(u.template);o.template=document.createElement("div"),o.template.appendChild(k.content.cloneNode(!0)),document.body.appendChild(o.template)}if(document.body.appendChild(o.zoomed),window.requestAnimationFrame(function(){document.body.classList.add("medium-zoom--opened")}),o.original.classList.add("medium-zoom-image--hidden"),o.zoomed.classList.add("medium-zoom-image--opened"),o.zoomed.addEventListener("click",E),o.zoomed.addEventListener("transitionend",m),o.original.getAttribute("data-zoom-src")){o.zoomedHd=o.zoomed.cloneNode(),o.zoomedHd.removeAttribute("srcset"),o.zoomedHd.removeAttribute("sizes"),o.zoomedHd.src=o.zoomed.getAttribute("data-zoom-src"),o.zoomedHd.onerror=function(){clearInterval(R),console.warn("Unable to reach the zoom image target "+o.zoomedHd.src),o.zoomedHd=null,v()};var R=setInterval(function(){o.zoomedHd.complete&&(clearInterval(R),o.zoomedHd.classList.add("medium-zoom-image--opened"),o.zoomedHd.addEventListener("click",E),document.body.appendChild(o.zoomedHd),v())},10)}else if(o.original.hasAttribute("srcset")){o.zoomedHd=o.zoomed.cloneNode(),o.zoomedHd.removeAttribute("sizes"),o.zoomedHd.removeAttribute("loading");var I=o.zoomedHd.addEventListener("load",function(){o.zoomedHd.removeEventListener("load",I),o.zoomedHd.classList.add("medium-zoom-image--opened"),o.zoomedHd.addEventListener("click",E),document.body.appendChild(o.zoomedHd),v()})}else v()})},E=function(){return new i(function(c){if(C||!o.original){c(b);return}var d=function v(){o.original.classList.remove("medium-zoom-image--hidden"),document.body.removeChild(o.zoomed),o.zoomedHd&&document.body.removeChild(o.zoomedHd),document.body.removeChild(O),o.zoomed.classList.remove("medium-zoom-image--opened"),o.template&&document.body.removeChild(o.template),C=!1,o.zoomed.removeEventListener("transitionend",v),o.original.dispatchEvent(P("medium-zoom:closed",{detail:{zoom:b}})),o.original=null,o.zoomed=null,o.zoomedHd=null,o.template=null,c(b)};C=!0,document.body.classList.remove("medium-zoom--opened"),o.zoomed.style.transform="",o.zoomedHd&&(o.zoomedHd.style.transform=""),o.template&&(o.template.style.transition="opacity 150ms",o.template.style.opacity=0),o.original.dispatchEvent(P("medium-zoom:close",{detail:{zoom:b}})),o.zoomed.addEventListener("transitionend",d)})},A=function(){var c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},d=c.target;return o.original?E():L({target:d})},M=function(){return u},H=function(){return T},B=function(){return o.original},T=[],N=[],C=!1,h=0,u=n,o={original:null,zoomed:null,zoomedHd:null,template:null};Object.prototype.toString.call(t)==="[object Object]"?u=t:(t||typeof t=="string")&&_(t),u=j({margin:0,background:"#fff",scrollOffset:40,container:null,template:null},u);var O=Et(u.background);document.addEventListener("click",r),document.addEventListener("keyup",p),document.addEventListener("scroll",s),window.addEventListener("resize",E);var b={open:L,close:E,toggle:A,update:a,clone:f,attach:_,detach:g,on:w,off:z,getOptions:M,getImages:H,getZoomedImage:B};return b};function St(e,t){t===void 0&&(t={});var n=t.insertAt;if(!(!e||typeof document>"u")){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",n==="top"&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}var zt=".medium-zoom-overlay{position:fixed;top:0;right:0;bottom:0;left:0;opacity:0;transition:opacity .3s;will-change:opacity}.medium-zoom--opened .medium-zoom-overlay{cursor:pointer;cursor:zoom-out;opacity:1}.medium-zoom-image{cursor:pointer;cursor:zoom-in;transition:transform .3s cubic-bezier(.2,0,.2,1)!important}.medium-zoom-image--hidden{visibility:hidden}.medium-zoom-image--opened{position:relative;cursor:pointer;cursor:zoom-out;will-change:transform}";St(zt);const Lt=xt,kt=60;function Ct(){function e(t,n,i=!1){let r=null;try{r=t.classList.contains("header-anchor")?t:document.getElementById(decodeURIComponent(n.slice(1)))}catch(s){console.warn(s)}if(r){const s=parseInt(window.getComputedStyle(r).paddingTop,10),p=window.scrollY+r.getBoundingClientRect().top-kt+s;window.scrollTo({left:0,top:p,...i?{behavior:"smooth"}:{}})}}window.addEventListener("click",t=>{const n=t.target.closest("a");if(n){const{origin:i,hash:r,target:s,pathname:p,search:a}=n,f=window.location;r&&s!=="_blank"&&i===f.origin&&p===f.pathname&&a===f.search&&r&&r!==f.hash&&n.classList.contains("header-anchor")&&(t.preventDefault(),history.pushState(null,"",r),e(n,r,!0),window.dispatchEvent(new Event("hashchange")))}},{capture:!0}),window.addEventListener("hashchange",t=>{t.preventDefault()})}function At(){function e(){return document.documentElement.scrollTop+window.innerHeight>=document.documentElement.scrollHeight}const t=60,n=document.getElementById("aside-marker"),i=document.getElementById("aside-container"),r=document.querySelectorAll(".island-doc .header-anchor");let s=null;const p=Array.from((i==null?void 0:i.getElementsByTagName("a"))||[]).map(g=>decodeURIComponent(g.hash));if(n&&!p.length){n.style.opacity="0";return}const a=(g,w)=>{if(s&&s.classList.remove("aside-active"),g[w]){g[w].classList.add("aside-active");const z=g[w].getAttribute("href"),L=p.findIndex(A=>A===z),E=i==null?void 0:i.querySelector(`a[href="#${z==null?void 0:z.slice(1)}"]`);E&&(s=E,s.classList.add("aside-active"),n.style.top=`${33+L*28}px`,n.style.opacity="1")}},f=()=>{if(e())a(r,r.length-1);else for(let g=0;g<r.length;g++){const w=r[g],z=r[g+1],L=window.scrollY,E=w.parentElement.offsetTop-t;if(g===0&&L===0&&a(r,0),!z){a(r,g);break}const A=z.parentElement.offsetTop-t;if(L>E&&L<A){a(r,g);break}}},_=pt(f,100);return requestAnimationFrame(f),window.addEventListener("scroll",_),()=>{window.removeEventListener("scroll",_)}}function It(){const e=document.querySelectorAll("img");Lt(e,{margin:100,background:"rgba(0, 0, 0, 0.7)"})}function Ot(){!ue()||(At(),Ct(),bt(),It())}if(typeof window<"u"){var de={get passive(){}};window.addEventListener("testPassive",null,de),window.removeEventListener("testPassive",null,de)}typeof window<"u"&&window.navigator&&window.navigator.platform&&(/iP(ad|hone|od)/.test(window.navigator.platform)||window.navigator.platform==="MacIntel"&&window.navigator.maxTouchPoints>1);var l={exports:{}},jt="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",Ht=jt,Nt=Ht;function fe(){}function ge(){}ge.resetWarningCache=fe;var Rt=function(){function e(i,r,s,p,a,f){if(f!==Nt){var _=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw _.name="Invariant Violation",_}}e.isRequired=e;function t(){return e}var n={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:ge,resetWarningCache:fe};return n.PropTypes=n,n};l.exports=Rt();var q={BASE:"base",BODY:"body",HEAD:"head",HTML:"html",LINK:"link",META:"meta",NOSCRIPT:"noscript",SCRIPT:"script",STYLE:"style",TITLE:"title",FRAGMENT:"Symbol(react.fragment)"};Object.keys(q).map(function(e){return q[e]});var le={accesskey:"accessKey",charset:"charSet",class:"className",contenteditable:"contentEditable",contextmenu:"contextMenu","http-equiv":"httpEquiv",itemprop:"itemProp",tabindex:"tabIndex"};Object.keys(le).reduce(function(e,t){return e[le[t]]=t,e},{});q.NOSCRIPT,q.SCRIPT,q.STYLE;Le.createContext({});var Pt=l.exports.shape({setHelmet:l.exports.func,helmetInstances:l.exports.shape({get:l.exports.func,add:l.exports.func,remove:l.exports.func})});l.exports.shape({helmet:l.exports.shape()}),l.exports.node.isRequired;Pt.isRequired;l.exports.object,l.exports.object,l.exports.oneOfType([l.exports.arrayOf(l.exports.node),l.exports.node]),l.exports.string,l.exports.bool,l.exports.bool,l.exports.object,l.exports.arrayOf(l.exports.object),l.exports.arrayOf(l.exports.object),l.exports.arrayOf(l.exports.object),l.exports.func,l.exports.arrayOf(l.exports.object),l.exports.arrayOf(l.exports.object),l.exports.string,l.exports.object,l.exports.string,l.exports.bool,l.exports.object;async function $t(){if(!document.getElementById("root"))throw new Error("#root element not found");{const t=document.querySelectorAll("[__island]");if(t.length===0)return;const{hydrateRoot:n}=await Oe(()=>import("react-dom/client"),[]);for(let i=0;i<t.length;i++){const r=t[i],[s,p]=r.getAttribute("__island").split(":"),a=window.ISLANDS[s];n(r,Ce(a,{...window.ISLAND_PROPS[p]}))}}}$t().then(()=>{setTimeout(()=>{Ot()})});
</script>
    </body>
  </html>
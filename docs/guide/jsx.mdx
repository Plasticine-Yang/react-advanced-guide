import { DemoBlock } from '@island/demo-block'

# è®¤è¯† JSX

## æå‡ºé—®é¢˜

- å¸¸ç”¨çš„å…ƒç´ ä¼šè¢« React å¤„ç†æˆä»€ä¹ˆï¼Ÿ
- JSX çš„ç¼–è¯‘è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

## 1. å¸¸ç”¨çš„å…ƒç´ ä¼šè¢« React å¤„ç†æˆä»€ä¹ˆï¼Ÿ

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼ŒåŒ…å«äº†ç»„ä»¶ç±»å‹çš„å…ƒç´ ã€æ™®é€š DOM å…ƒç´ ã€çº¯æ–‡æœ¬å…ƒç´ 

```tsx
import React, { useState } from 'react'

const toLearn = ['react', 'vue', 'vite', 'node']

interface SimpleComponentProps {
  message?: string
}
const SimpleComponent = ({
  message = 'A Simple Component.',
}: SimpleComponentProps) => <div>{message}</div>

const JSXDemo1 = () => {
  const [status, setStatus] = useState(false)

  const renderByFunc = () => <div>Rendered by function.</div>
  const el = (
    <>
      {/* element å…ƒç´ ç±»å‹ */}
      <div>Hello World</div>
      {/* fragment ç±»å‹ */}
      <React.Fragment>
        <div>ğŸš€ğŸš€ğŸš€</div>
      </React.Fragment>
      {/* text æ–‡æœ¬ç±»å‹ */}
      This is a text element.
      {/* æ•°ç»„èŠ‚ç‚¹ç±»å‹ */}
      {toLearn.map((item) => (
        <div key={item}>[Array Element] -- let us learn {item} </div>
      ))}
      {/* ç»„ä»¶ç±»å‹ */}
      <SimpleComponent />
      {/* ä¸‰ç›®è¿ç®— */}
      {status ? (
        <SimpleComponent message="status: true" />
      ) : (
        <SimpleComponent message="status: false" />
      )}
      {/* å‡½æ•°æ¸²æŸ“ */}
      {renderByFunc()}
      <button onClick={() => setStatus(!status)}>toggle status</button>
    </>
  )

  console.log('ç»è¿‡ React.createElement å¤„ç†åçš„ el:', el)

  return el
}

export { JSXDemo1 }
```

import { JSXDemo1 } from '~/demos/jsx/demo1'

<DemoBlock>
  <JSXDemo1 />
</DemoBlock>

### 1.1. ç»è¿‡ babel å¤„ç†åçš„æ ·å­

```js
React.createElement(
  'div',
  null,
  React.createElement(TextComponent, null),
  React.createElement('div', null, 'hello,world'),
  'let us learn React!',
)
```

:::info

è¿™ä¹Ÿæ­£æ˜¯ä¸ºä»€ä¹ˆåœ¨ä½¿ç”¨è€ç‰ˆæœ¬ React æ—¶ï¼Œç¼–å†™ jsx æ–‡ä»¶æ—¶æ€»æ˜¯è¦å†™ä¸Š `import React from 'react'`

å› ä¸ºç»è¿‡ babel ç¼–è¯‘åï¼Œä¼šæœ‰ `React.createElement` è¿™æ ·çš„è°ƒç”¨ï¼Œåªæœ‰å¼•å…¥äº† React æ‰èƒ½æ­£å¸¸è¿è¡Œ

:::

### 1.2. ç»è¿‡ React.createElement å¤„ç†åçš„æ ·å­

![ç»è¿‡createElementå¤„ç†åçš„å…ƒç´ ](https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/%E7%BB%8F%E8%BF%87createElement%E5%A4%84%E7%90%86%E5%90%8E%E7%9A%84%E5%85%83%E7%B4%A0.png)

:::tip

å¯ä»¥æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¾“å‡º

:::

createElement çš„å¤„ç†è§„åˆ™ï¼š

![createElement çš„å¤„ç†è§„åˆ™](https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/createElement%E5%A4%84%E7%90%86%E8%A7%84%E5%88%99.png)

### 1.3. ç»è¿‡ React åº•å±‚è°ƒå’Œå¤„ç†åçš„æ ·å­

:::info

React element å¯¹è±¡çš„æ¯ä¸€ä¸ªå­èŠ‚ç‚¹éƒ½ä¼šå½¢æˆä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ fiber å¯¹è±¡ï¼Œç„¶åé€šè¿‡ siblingã€returnã€child å°†æ¯ä¸€ä¸ª fiber å¯¹è±¡è”ç³»èµ·æ¥

:::

#### 1.3.1. Fiber Tag

ä¸åŒç§ç±»çš„ React Element å¯¹åº”ä¸åŒ Tag çš„ Fiber å¯¹è±¡ï¼Œå¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š

```ts
export const FunctionComponent = 0 // å‡½æ•°ç»„ä»¶
export const ClassComponent = 1 // ç±»ç»„ä»¶
export const IndeterminateComponent = 2 // åˆå§‹åŒ–çš„æ—¶å€™ä¸çŸ¥é“æ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ç±»ç»„ä»¶
export const HostRoot = 3 // Root Fiber å¯ä»¥ç†è§£ä¸ºæ ¹å…ƒç´  ï¼Œ é€šè¿‡reactDom.render()äº§ç”Ÿçš„æ ¹å…ƒç´ 
export const HostPortal = 4 // å¯¹åº”  ReactDOM.createPortal äº§ç”Ÿçš„ Portal
export const HostComponent = 5 // dom å…ƒç´  æ¯”å¦‚ <div>
export const HostText = 6 // æ–‡æœ¬èŠ‚ç‚¹
export const Fragment = 7 // å¯¹åº” <React.Fragment>
export const Mode = 8 // å¯¹åº” <React.StrictMode>
export const ContextConsumer = 9 // å¯¹åº” <Context.Consumer>
export const ContextProvider = 10 // å¯¹åº” <Context.Provider>
export const ForwardRef = 11 // å¯¹åº” React.ForwardRef
export const Profiler = 12 // å¯¹åº” <Profiler/ >
export const SuspenseComponent = 13 // å¯¹åº” <Suspense>
export const MemoComponent = 14 // å¯¹åº” React.memo è¿”å›çš„ç»„ä»¶
```

ä¸‹é¢çš„ jsx ä»£ç ä¼šè¢«è½¬æˆå¦‚ä¸‹ fiber ç»“æ„ï¼š

```jsx
const reactElement = (
  <div style={{ marginTop: '100px' }} className="container">
    {/* element å…ƒç´ ç±»å‹ */}
    <div>hello,world</div>
    {/* fragment ç±»å‹ */}
    <React.Fragment>
      <div> ğŸ‘½ğŸ‘½ </div>
    </React.Fragment>
    {/* text æ–‡æœ¬ç±»å‹ */}
    my name is alien
    {/* æ•°ç»„èŠ‚ç‚¹ç±»å‹ */}
    {toLearn.map((item) => (
      <div key={item}>let us learn {item} </div>
    ))}
    {/* ç»„ä»¶ç±»å‹ */}
    <TextComponent />
    {/* ä¸‰å…ƒè¿ç®— */}
    {this.status ? <TextComponent /> : <div>ä¸‰å…ƒè¿ç®—</div>}
    {/* å‡½æ•°æ‰§è¡Œ */}
    {this.renderFoot()}
    <button onClick={() => console.log(this.render())}>
      æ‰“å°renderåçš„å†…å®¹
    </button>
  </div>
)
```

![å…ƒç´ è¢«è½¬æ¢åçš„ fiber ç»“æ„](https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/%E5%85%83%E7%B4%A0%E8%A2%AB%E8%BD%AC%E6%8D%A2%E5%90%8E%E7%9A%84fiber%E7%BB%93%E6%9E%84.png)

æ€»çš„æ¥è¯´ï¼Œfiber çš„ç»“æ„å¦‚ä¸‹ï¼š

- childï¼š ä¸€ä¸ªç”±çˆ¶çº§ fiber æŒ‡å‘å­çº§ fiber çš„æŒ‡é’ˆã€‚
- returnï¼šä¸€ä¸ªå­çº§ fiber æŒ‡å‘çˆ¶çº§ fiber çš„æŒ‡é’ˆã€‚
- sibling: ä¸€ä¸ª fiber æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼Ÿ fiber çš„æŒ‡é’ˆã€‚

## 2. åŠ¨æ‰‹å®è·µ -- æé«˜ç»„ä»¶å¯æ§æ€§

ç°åœ¨`JSXDemo1`ç»„ä»¶çš„`props.children`ä¸­çš„ç»“æ„æ¯”è¾ƒå¤æ‚ï¼Œæ—¢æœ‰å¯¹è±¡ç±»å‹(å¦‚`ReactElement`)ï¼Œåˆæœ‰æ•°ç»„ç±»å‹ï¼Œè¿˜æœ‰çº¯å­—ç¬¦ä¸²ç±»å‹

ä¸ºäº†æé«˜å¯æ§æ€§ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›æ”¹é€ ï¼ŒåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

1. å°† children æ‰å¹³åŒ–ï¼ŒæŠŠé‡Œé¢çš„æ•°ç»„å…ƒç´ æ‹å¹³
2. å»é™¤çº¯å­—ç¬¦ä¸²å­å…ƒç´ 
3. å¾€ children çš„æœ«å°¾æ’å…¥æ–°å…ƒç´ 
4. å…‹éš†æ–°çš„å…ƒç´ èŠ‚ç‚¹å¹¶æ¸²æŸ“

:::tip

ç¬¬ä¸‰ç¬¬å››æ­¥çº¯ç²¹æ˜¯ä¸ºäº†åŠ æ·±è¯»è€…å¯¹ jsx ç¼–è¯‘åçš„ React.element ç»“æ„çš„ç†è§£ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†ç†Ÿæ‚‰ React API çš„ä½¿ç”¨

:::

```tsx{44-69}
import React, { useState } from 'react'

const toLearn = ['react', 'vue', 'vite', 'node']

interface SimpleComponentProps {
  message?: string
}
const SimpleComponent = ({
  message = 'A Simple Component.',
}: SimpleComponentProps) => <div>{message}</div>

const JSXDemo2 = () => {
  const [status, setStatus] = useState(false)

  const renderByFunc = () => <div>Rendered by function.</div>
  const el = (
    <>
      {/* element å…ƒç´ ç±»å‹ */}
      <div>Hello World</div>
      {/* fragment ç±»å‹ */}
      <React.Fragment>
        <div>ğŸš€ğŸš€ğŸš€</div>
      </React.Fragment>
      {/* text æ–‡æœ¬ç±»å‹ */}
      This is a text element.
      {/* æ•°ç»„èŠ‚ç‚¹ç±»å‹ */}
      {toLearn.map((item) => (
        <div key={item}>[Array Element] -- let us learn {item} </div>
      ))}
      {/* ç»„ä»¶ç±»å‹ */}
      <SimpleComponent />
      {/* ä¸‰ç›®è¿ç®— */}
      {status ? (
        <SimpleComponent message="status: true" />
      ) : (
        <SimpleComponent message="status: false" />
      )}
      {/* å‡½æ•°æ¸²æŸ“ */}
      {renderByFunc()}
      <button onClick={() => setStatus(!status)}>toggle status</button>
    </>
  )

  // 1. children æ•°ç»„æ‰å¹³åŒ– -- å°†å†…éƒ¨çš„ æ•°ç»„èŠ‚ç‚¹ æ‹å¹³
  const { children } = el.props
  const flatChildren = React.Children.toArray(children)
  console.log('æ‰å¹³åŒ–åçš„ children:', flatChildren)

  // 2. å»é™¤çº¯å­—ç¬¦ä¸²å­å…ƒç´ 
  const newChildren: any[] = []
  React.Children.forEach(flatChildren, (child) => {
    if (React.isValidElement(child)) {
      newChildren.push(child)
    }
  })

  // 3. å¾€ children çš„æœ«å°¾æ’å…¥æ–°å…ƒç´ 
  const lastChild = React.createElement(
    'div',
    { className: 'last' },
    'last element',
  )
  newChildren.push(lastChild)

  // 4. å…‹éš†æ–°çš„å…ƒç´ èŠ‚ç‚¹å¹¶æ¸²æŸ“
  const newEl = React.cloneElement(el, {}, ...newChildren)
  console.log('å¢å¼ºå¯æ§æ€§åçš„ el:', newEl)

  return newEl
}

export { JSXDemo2 }
```

import { JSXDemo2 } from '~/demos/jsx/demo2.tsx'

<DemoBlock>
  <JSXDemo2 />
</DemoBlock>

### 2.1. å°† children æ‰å¹³åŒ–ï¼ŒæŠŠé‡Œé¢çš„æ•°ç»„å…ƒç´ æ‹å¹³

ä½¿ç”¨`React.Children.toArray()`å°† children è½¬æˆæ‰å¹³åŒ–ã€è§„èŒƒåŒ–çš„æ•°ç»„ï¼Œåœ¨æˆ‘ä»¬éœ€è¦éå† children çš„æ—¶å€™å¾ˆæœ‰ç”¨

```tsx
// 1. children æ•°ç»„æ‰å¹³åŒ– -- å°†å†…éƒ¨çš„ æ•°ç»„èŠ‚ç‚¹ æ‹å¹³
const { children } = el.props
const flatChildren = React.Children.toArray(children)
console.log('æ‰å¹³åŒ–åçš„ children:', flatChildren)
```

### 2.2. å»é™¤çº¯å­—ç¬¦ä¸²å­å…ƒç´ 

ä½¿ç”¨`React.Children.forEach`å®é™…ä¸Šå°±ç­‰ä»·äº:

1. React.Children.toArray
2. Array.prototype.forEach

å› æ­¤æˆ‘ä»¬ç›´æ¥ä½¿ç”¨`React.Children.forEach(children)`ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†è®©è¯»è€…ç†Ÿæ‚‰ React API æ‰å°†å…¶åˆ†å¼€ä½¿ç”¨çš„

:::tip

flatChildren å·²ç»æ˜¯ä¸€ä¸ªæ‰å¹³åŒ–ã€è§„èŒƒåŒ–çš„æ•°ç»„äº†ï¼Œå› æ­¤ç›´æ¥ç”¨`flatChildren.forEach`ä¹Ÿå¯ä»¥

:::

```tsx
// 2. å»é™¤çº¯å­—ç¬¦ä¸²å­å…ƒç´ 
const newChildren: any[] = []
React.Children.forEach(flatChildren, (child) => {
  if (React.isValidElement(child)) {
    newChildren.push(child)
  }
})
```

### 2.3. å¾€ children çš„æœ«å°¾æ’å…¥æ–°å…ƒç´ 

```tsx
// 3. å¾€ children çš„æœ«å°¾æ’å…¥æ–°å…ƒç´ 
const lastChild = React.createElement(
  'div',
  { className: 'last' },
  'last element',
)
newChildren.push(lastChild)
```

ä¸ä¹‹ç­‰ä»·çš„å†™æ³•:

```tsx
newChildren.push(<div className="last">last element</div>)
```

### 2.4. å…‹éš†æ–°çš„å…ƒç´ èŠ‚ç‚¹å¹¶æ¸²æŸ“

```tsx
// 4. å…‹éš†æ–°çš„å…ƒç´ èŠ‚ç‚¹å¹¶æ¸²æŸ“
const newEl = React.cloneElement(el, {}, ...newChildren)
console.log('å¢å¼ºå¯æ§æ€§åçš„ el:', newEl)

return newEl
```

:::tip

`React.cloneElement` çš„ä½œç”¨æ˜¯å°†ä¼ å…¥çš„æ–° props ä¸è¢«å…‹éš†å…ƒç´ çš„ props æµ…å±‚åˆå¹¶åè¿”å›

åœ¨è¿™é‡Œåˆ™æ˜¯å…‹éš†åŸæ¥çš„ el å…ƒç´ ï¼Œå¹¶ä½¿ç”¨æ–°çš„ newChildren ä½œä¸ºå…¶ `props.children`

:::

:::info{title=æé—®}

React.createElement å’Œ React.cloneElement çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

å‰è€…ç”¨äºåˆ›å»ºå…ƒç´ ï¼Œåè€…ç”¨äºå¯¹å·²æœ‰å…ƒç´ è¿›è¡Œä¿®æ”¹å¹¶è¿”å›ä¸€ä¸ªæ–°çš„ React.element å¯¹è±¡

:::

## 3. Babel æ˜¯å¦‚ä½•è§£æ JSX çš„ï¼Ÿ

ä½¿ç”¨ Babel ç¼–è¯‘ jsx æ—¶ï¼Œä¸»è¦ä½¿ç”¨çš„æ˜¯ `@babel/preset-react` è¿™ä¸ª presetï¼Œå…¶ä¸­èµ·ä¸»è¦ä½œç”¨çš„æ˜¯è¯¥ preset å†…éƒ¨çš„ä¸¤ä¸ªæ’ä»¶:

- `@babel/plugin-syntax-jsx`: è®© Babel è§£æ jsx è¯­æ³•
- `@babel/plugin-transform-react-jsx`: å°† jsx å…ƒç´ è½¬æ¢æˆ React APIï¼Œå¦‚ `React.createElement`

è€Œå…³äº React API çš„è½¬æ¢åˆ™åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿç»“æœï¼Œæˆ‘ä»¬ç¼–å†™ä¸€æ®µç®€å•çš„ ts ä»£ç ï¼Œè°ƒç”¨ `@babel/core` çš„ `transformSync` æŸ¥çœ‹ä¸€ä¸‹ç¼–è¯‘ç»“æœ

```shell
pnpm i @bebel/core @babel/preset-react @types/babel__core -D
```

```ts
import { transformSync } from '@babel/core'

const res = transformSync('<div>jsx</div>', {
  presets: ['@babel/preset-react'],
})!

console.log(res.code)
```

åˆšåˆšè¯´è¿‡äº†ï¼Œä¸€å…±æœ‰ä¸¤ç§è½¬æ¢æ–¹å¼ï¼š

- React Classic Runtime
  æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼Œé»˜è®¤å°±æ˜¯ä»¥ `Classic Runtime` çš„æ–¹å¼è½¬æ¢ jsx çš„

  ![@babel/preset-reacté»˜è®¤é…ç½®](https://raw.githubusercontent.com/Plasticine-Yang/plasticine-cloud-image/main/images/react-advanced-guide/babel-preset-react%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE.png)

  è¿™ç§æ–¹å¼ç¼–è¯‘å‡ºæ¥çš„ç»“æœå¦‚ä¸‹:

  ```text
  /*#__PURE__*/React.createElement("div", null, "jsx");
  ```

  ä¹Ÿå°±æ˜¯ `React.createElement` çš„æ–¹å¼ï¼Œå› æ­¤æˆ‘ä»¬çš„æºä»£ç ä¸­éœ€è¦æ˜¾å¼å¼•å…¥ React

- React Automatic Runtime

  å°†ä»£ç æ”¹å†™å¦‚ä¸‹:

  ```ts
  import { transformSync } from '@babel/core'

  const res = transformSync('<div>jsx</div>', {
    presets: [['@babel/preset-react', { runtime: 'automatic' }]],
  })!

  console.log(res.code)
  ```

  ç¼–è¯‘çš„ç»“æœå¦‚ä¸‹:

  ```text
  import { jsx as _jsx } from "react/jsx-runtime";
  /*#__PURE__*/_jsx("div", {
    children: "jsx"
  });
  ```
